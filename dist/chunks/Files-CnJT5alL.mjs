/*! third party licenses: dist/vendor.LICENSE.txt */
import{u as w,C as v,y as b,_ as g,v as y}from"./index-BdIeO5n5.mjs";import{bY as m,c2 as f,c8 as q,c9 as C}from"../core-common.mjs";import{c as R,u as x}from"./index-Dizl7-P2.mjs";import{l as D}from"./logger-abzvQ-j7.mjs";var l;const c="/files/".concat((l=m())==null?void 0:l.uid),H=f("dav"+c),k=(r=H)=>{const t=R(r),n=e=>{t==null||t.setHeaders({"X-Requested-With":"XMLHttpRequest",requesttoken:e!=null?e:""})};return q(n),n(C()),x().patch("fetch",(e,a)=>{const o=a.headers;return o!=null&&o.method&&(a.method=o.method,delete o.method),fetch(e,a)}),t},z=function(r){return r.split("").reduce(function(t,n){return t=(t<<5)-t+n.charCodeAt(0),t&t},0)},A=k(),u=function(r){var t;const n=(t=m())==null?void 0:t.uid;if(!n)throw new Error("No user id found");const e=r.props,a=b(e==null?void 0:e.permissions),o=(e["owner-id"]||n).toString(),s=f("dav"+c+r.filename),i={id:(e==null?void 0:e.fileid)<0?z(s):(e==null?void 0:e.fileid)||0,source:s,mtime:new Date(r.lastmod),mime:r.mime||"application/octet-stream",size:(e==null?void 0:e.size)||0,permissions:a,owner:o,root:c,attributes:{...r,...e,hasPreview:e==null?void 0:e["has-preview"],failed:(e==null?void 0:e.fileid)<0}};return delete i.attributes.props,r.type==="file"?new g(i):new y(i)},X=(r="/")=>{const t=new AbortController,n=w();return new v(async(e,a,o)=>{o(()=>t.abort());try{const s=await A.getDirectoryContents(r,{details:!0,data:n,includeSelf:!0,signal:t.signal}),i=s.data[0],p=s.data.slice(1);if(i.filename!==r)throw new Error("Root node does not match requested path");e({folder:u(i),contents:p.map(d=>{try{return u(d)}catch(h){return D.error("Invalid node detected '".concat(d.basename,"'"),{error:h}),null}}).filter(Boolean)})}catch(s){a(s)}})};export{X as a,k as g,z as h,u as r};
